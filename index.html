<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Grow Companion</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & Firebase -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        doc,
        onSnapshot,
        setDoc,
        setLogLevel,
        collection,
        query,
        where,
        addDoc,
        getDoc,
        getDocs,
        writeBatch,
        arrayUnion,
        arrayRemove,
        updateDoc,
        deleteDoc
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
      window.firebase = {
        initializeApp,
        getAuth,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        onAuthStateChanged,
        signOut,
        getFirestore,
        doc,
        onSnapshot,
        setDoc,
        setLogLevel,
        collection,
        query,
        where,
        addDoc,
        getDoc,
        getDocs,
        writeBatch,
        arrayUnion,
        arrayRemove,
        updateDoc,
        deleteDoc
      };
    </script>
    <style>
      body {
        font-family: 'Inter', sans-serif;
        background-color: #111827; /* gray-900 */
        color: #f3f4f6; /* gray-100 */
      }
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    </style>
  </head>
  <body>
    <div id="root"></div>
    <script type="text/babel">
      const {
        initializeApp,
        getAuth,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        onAuthStateChanged,
        signOut,
        getFirestore,
        doc,
        onSnapshot,
        setDoc,
        setLogLevel,
        collection,
        query,
        where,
        addDoc,
        getDoc,
        getDocs,
        writeBatch,
        arrayUnion,
        arrayRemove,
        updateDoc,
        deleteDoc
      } = window.firebase;
      const { useState, useEffect, useMemo, createContext, useContext } = React;

      // --- Firebase and App Config ---
      const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-grow-app-v5';
      const firebaseConfigJSON = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
      const firebaseConfig = JSON.parse(firebaseConfigJSON);

      let app, db, auth;
      try {
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        setLogLevel('error');
      } catch (e) {
        console.error("Error initializing Firebase: ", e);
      }

      // --- Initial Data Structures ---
      const initialPhases = [
        { id: 'p1', title: 'Phase 1: The Nursery', timeline: 'Weeks 0-3 (Buy before Day 0)', items: [
            { id: 'i1', name: 'Heat Mat + Thermostat Kit', cost: 695, reason: '(Day 0) Your nursery. The thermostat gives you precise temperature control for germination.', link: 'https://plantliving.co.za/products/seedling-heat-mat-thermostat-kit-25x53cm', purchased: false, suggestions: "Upgrade: An AC Infinity Controller 69 can manage this mat plus your fans on a single app.\nBudget: A simple heat mat (no thermostat) saves money if your room is already a stable temperature." },
            { id: 'i2', name: 'Humidity Dome', cost: 149, reason: '(Day 0) Traps humidity for the heat mat. Fits perfectly.', link: 'https://plantliving.co.za/products/propagation-humidity-dome-high-54-x-28-x-25-cm', purchased: false, suggestions: "This is a standard item. No real alternatives, but ensure it's a 'high top' dome to give seedlings room." },
            { id: 'i3', name: 'T8 Light (Fitting + Tube)', cost: 125, reason: '(Day 3-21) A low-power light to hang over the dome. Prevents seedlings from stretching.', link: 'https://hydroponic.co.za/hydroponics/t8-led-tubes-and-fittings-60cm/', purchased: false, suggestions: "Alternative: A small, 100W 'Quantum Board' LED can be used, but must be dimmed way down and kept far away. The T8 is cheap and perfect for the job." },
            { id: "i4", name: "Digital pH Pen (Basic)", cost: 190, reason: "(Day 0) Non-negotiable. Must test water pH from the very first watering.", link: "https://mihydro.co.za/shop/home/35-digital-ph-meter-hydroponics.html", purchased: false, suggestions: "Upgrade: A Bluelab pH Pen (around R2400) is the industry standard. It's far more reliable, holds calibration longer, and is fully waterproof. This is a highly recommended first upgrade." },
            { id: "i5", name: "EHG Nutrient Tripak", cost: 265, reason: "(Week 2) Seedlings will need their first 1/4 strength feeding around Day 10-14.", link: "https://www.seedsforafrica.co.za/products/ehg-easy-hydro-grow-tripak-hydroponic-soil-nutrient-kit", purchased: false, suggestions: "Alternative: BioBizz is a popular organic nutrient line (Bio-Grow, Bio-Bloom, Top-Max). It's more forgiving for new growers but can be more expensive." },
            { id: "i6", name: "Digital TDS/EC Meter", cost: 250, reason: "(Week 2) Needed with nutrients to measure feed strength and prevent burning.", link: "https://hydroponic.co.za/hydroponics/ec-tds-temp-meter-pen/", purchased: false, suggestions: "This is a standard item. Most budget pens (R200-R300) work well. The 'upgrade' is a combo pen like the Bluelab Combo Meter, but it's very expensive." }
        ]},
        { id: 'p2', title: 'Phase 2: The "Forever Homes"', timeline: 'Weeks 1-3 (Buy before Week 3)', items: [
            { id: "i7", name: "All 6 Pots (2x 19L & 4x 38L)", cost: 792, reason: "(Week 3) Transplant Day. Seedlings must be moved from starter pots.", link: "https://thegrobro.co.za/product-category/fabric-pots/", purchased: false, suggestions: "Fabric pots are the best. Plastic pots are cheaper and reusable, but fabric pots 'air prune' the roots, leading to a much healthier root ball." },
            { id: "i8", name: "4x 50L Bags of Craft Soil", cost: 1040, reason: "(Week 3) Needed to fill all 6 pots on Transplant Day. (Link is for one bag x4)", link: "https://www.greenhouston.co.za/products/organic-classic-craft-soil", purchased: false, suggestions: "Brands like Freedom Farms or Orgasoilux are 'living soils' pre-loaded with nutrients. Budget: A simple Coco Coir and Perlite mix (like a 70/30 blend) is cheaper but contains no nutrients, so you must feed from Day 1." },
            { id: "i9", name: "90x90cm Grow Tent", cost: 1930, reason: "(Week 3) Indoor plants move from nursery into this tent.", link: "https://homegrodepot.co.za/products/indoor-grow-tent-90-x-90-x-180", purchased: false, suggestions: "Upgrade: Tents from brands like AC Infinity or Gorilla Grow Tent use much thicker 1680D+ fabric and steel poles, making them more durable and light-proof. They cost 2-3x more." },
            { id: "i10", name: "250W LED Grow Light (200W)", cost: 2500, reason: "(Week 3) Your new 'sun'. T8 light is no longer strong enough. (This 200W is perfect)", link: "https://www.akira420.co.za/product/200w-full-spectrum-quantum-board-samsung-grow-light/", purchased: false, suggestions: "Look for lights with Samsung LM301H or LM301B diodes, as they are top-tier in efficiency. A 'bar-style' light will give more even coverage than a single 'quantum board'." },
            { id: "i11", name: "Digital Plug-in Timer", cost: 210, reason: "(Week 3) Must automate the new light to a consistent 18/6 schedule.", link: "https://hydroponic.co.za/hydroponics/ram-digital-plug-timer/", purchased: false, suggestions: "A basic mechanical timer is cheaper (around R100), but digital is far more reliable and won't make a 'clicking' sound. This is a good budget-friendly item." },
            { id: "i12", name: "2x Clip-on Fans", cost: 830, reason: "(Week 3) Internal air circulation to strengthen stems. (R415 each x2)", link: "https://plantliving.co.za/products/small-oscillating-grip-clip-fan-6-150mm", purchased: false, suggestions: "Oscillating fans are key. Non-oscillating (static) fans are cheaper but can cause 'wind burn' on your leaves. The oscillating feature is worth the extra cost." }
        ]},
        { id: 'p3', title: 'Phase 3: The Outdoor Fortress', timeline: 'Weeks 4-6 (Buy after transplant)', items: [
            { id: "i13", name: "Small 'Walk-in' Greenhouse", cost: 2300, reason: "Protects 4 outdoor pots from harsh wind/rain. (This 4-shelf model is ideal)", link: "https://growingtechsa.co.za/product/tiered-walk-in-greenhouse-4-shelves/", purchased: false, suggestions: "Budget: You can build a simple hoop house with PVC pipes and greenhouse plastic for under R500. It's less durable but provides the same protection." },
            { id: "i14", name: "Organic Pesticide (Neem Oil)", cost: 110, reason: "Start a weekly preventative spray routine for outdoor pests.", link: "https://www.greenhouston.co.za/products/bioneem-by-biogrow", purchased: false, suggestions: "Neem oil is the standard. 'Bioneem' by Biogrow is a popular brand. Always mix with a few drops of dish soap to help it emulsify in water." },
            { id: "i15", name: "Stakes & Plant Ties", cost: 125, reason: "Be ready to support plants as they grow taller.", link: "https://happyharvest.co.za/product/bamboo-stakes/", purchased: false, suggestions: "A 'Trellis Net' is a great alternative to stakes for supporting multiple branches, especially if you plan to do any plant training (LST)." }
        ]},
        { id: 'p4', title: 'Phase 4: The "Stealth" Upgrade', timeline: 'Weeks 7-8 (Buy before flower)', items: [
            { id: "i16", name: "6-Inch Fan + Carbon Filter Kit", cost: 1800, reason: "(Critical for Flower) Must be running to control heat and eliminate smell.", link: "https://growfolk.co.za/product/inline-exhaust-fan-150mm-6/", purchased: false, suggestions: "Upgrade: An AC Infinity EC Fan (like the Cloudline S6) is silent and can be automated with a controller. This is the single biggest 'quality of life' upgrade for an indoor grow." }
        ]},
        { id: 'p5', title: 'Phase 5: The Finish Line', timeline: 'Week 16+ (Buy before harvest)', items: [
            { id: "i17", name: "Trimming Shears", cost: 110, reason: "Lowest priority. Only needed on harvest day.", link: "https://www.sahorticulture.co.za/shop/hardware/fine-precision-pruning-scissors/", purchased: false, suggestions: "Any high-quality spring-loaded trimming scissors will work. Look for 'Fiskars' brand or similar. Avoid cheap, unbranded shears as they will gum up and rust quickly." }
        ]}
      ];
      const initialProject = {
        name: "My First Grow",
        budget: { phases: initialPhases },
        plants: [],
        journal: {}
      };

      // --- Database References ---
      const getProjectRef = (projectId) => doc(db, "projects", projectId);
      const getProjectsCol = (userId) => collection(db, "users", userId, "projects");
      const getFriendsCol = (userId) => collection(db, "users", userId, "friends");
      const getFriendRequestsCol = (userId) => collection(db, "users", userId, "friendRequests");
      const getUserDoc = (userId) => doc(db, "users", userId);
      const getUsersCol = () => collection(db, "users");


      // --- Helper Functions ---
      const formatCurrency = (number) => {
        return new Intl.NumberFormat('en-ZA', {
          style: 'currency',
          currency: 'ZAR',
        }).format(number);
      };

      const formatDate = (date) => {
        if (!date) return 'No date';
        let d;
        if (date && date.toDate) { // It's a Firebase Timestamp
          d = date.toDate();
        } else if (typeof date === 'string' || typeof date === 'number') {
          d = new Date(date);
        } else if (date instanceof Date) {
          d = date;
        } else {
          return 'Invalid date';
        }
        return d.toLocaleDateString('en-ZA', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
        });
      };

      // --- API Call to Gemini ---
      async function getAISuggestion(item) {
        const systemPrompt = "You are a friendly and expert hydroponics and indoor growing advisor in South Africa. A user is looking at a specific product for their grow setup. Provide a short, 1-2 paragraph suggestion for a 'budget' alternative AND an 'upgrade' alternative available in South Africa. Mention brands or features to look for. Be encouraging and helpful.";
        const userQuery = `I'm planning my grow setup and looking at this item:
      - Item: ${item.name}
      - My Budgeted Cost: ${formatCurrency(item.cost)}
      - My Reason: ${item.reason}
      What are some good budget or upgrade alternatives I can find in SouthAfrica?`;
        
        const apiKey = ""; // Handled by environment
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        const payload = {
          contents: [{ parts: [{ text: userQuery }] }],
          tools: [{ "google_search": {} }],
          systemInstruction: {
            parts: [{ text: systemPrompt }]
          },
        };

        try {
          // Implement exponential backoff
          let response;
          let delay = 1000; // start with 1 second
          for (let i = 0; i < 5; i++) { // Retry up to 5 times
            response = await fetch(apiUrl, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });

            if (response.ok) {
              break; // Success
            }

            if (response.status === 429) {
              await new Promise(resolve => setTimeout(resolve, delay));
              delay *= 2; // Double the delay
            } else {
              throw new Error(`API request failed with status ${response.status}`);
            }
          }
          
          if (!response.ok) {
            throw new Error(`API request failed after retries with status ${response.status}`);
          }

          const result = await response.json();
          // *** FIX: Replaced all '?' with '&&' for Babel compatibility ***
          const candidate = (result.candidates && result.candidates[0]);

          if (candidate && candidate.content && candidate.content.parts && candidate.content.parts[0] && candidate.content.parts[0].text) {
            return candidate.content.parts[0].text;
          } else {
            return "Sorry, I couldn't get a suggestion for that item. The AI returned an empty response. Please try again.";
          }
        } catch (error) {
          console.error("Gemini API call failed:", error);
          return `Error: Could not fetch suggestion. ${error.message}`;
        }
      }

      // --- React Context for Auth ---
      const AuthContext = createContext();

      const AuthProvider = ({ children }) => {
        const [user, setUser] = useState(null);
        const [loading, setLoading] = useState(true);

        useEffect(() => {
          if (!auth) {
            setLoading(false);
            return;
          }
          const unsubscribe = onAuthStateChanged(auth, async (user) => {
            if (user) {
              // Get user profile
              const userRef = getUserDoc(user.uid);
              const docSnap = await getDoc(userRef);
              if (docSnap.exists()) {
                setUser({ ...user, ...docSnap.data() });
              } else {
                // Create user profile
                const newUserProfile = {
                  email: user.email,
                  uid: user.uid,
                  displayName: user.email.split('@')[0] // simple display name
                };
                await setDoc(userRef, newUserProfile);
                setUser(newUserProfile);
              }
            } else {
              setUser(null);
            }
            setLoading(false);
          });
          return () => unsubscribe();
        }, []);

        const value = { user, loading };
        
        return (
          <AuthContext.Provider value={value}>
            {!loading && children}
          </AuthContext.Provider>
        );
      };

      const useAuth = () => {
        return useContext(AuthContext);
      };

      // --- React Components ---

      // --- Icons ---
      const IconBudget = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>;
      const IconPlants = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 2a7 7 0 0 0-7 7c0 5 7 13 7 13s7-8 7-13a7 7 0 0 0-7-7Z"/><circle cx="12" cy="9" r="2.5"/></svg>;
      const IconJournal = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2Z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7Z"/></svg>;
      const IconChevron = ({ isOpen }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={`text-gray-400 transform transition-transform ${isOpen ? 'rotate-180' : 'rotate-0'}`}><polyline points="6 9 12 15 18 9"></polyline></svg>;
      const IconPencil = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>;
      const IconTrash = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>;
      const IconAdd = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>;
      const IconBack = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>;
      const IconLogout = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>;
      const IconShare = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path><polyline points="16 6 12 2 8 6"></polyline><line x1="12" y1="2" x2="12" y2="15"></line></svg>;
      const IconProject = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>;
      const IconFriends = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M22 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>;
      const IconAccept = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>;
      const IconDecline = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>;
      const IconSend = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>;

      // --- Common Components ---
      const LoadingSpinner = ({ text = "Loading..." }) => (
        <div className="flex flex-col justify-center items-center h-screen">
          <div className="animate-spin rounded-full h-32 w-32 border-t-2 border-b-2 border-green-400"></div>
          <p className="absolute text-lg text-gray-200">{text}</p>
        </div>
      );
      
      const Modal = ({ show, onClose, title, children }) => {
        if (!show) return null;
        return (
          <div 
            className="fixed inset-0 bg-black bg-opacity-75 z-50 flex justify-center items-center"
            onClick={onClose}
          >
            <div 
              className="bg-gray-800 rounded-xl shadow-xl w-full max-w-lg p-6 m-4"
              onClick={e => e.stopPropagation()}
            >
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-2xl font-bold text-white">{title}</h2>
                <button onClick={onClose} className="text-gray-400 hover:text-white">
                  <IconDecline />
                </button>
              </div>
              <div>
                {children}
              </div>
            </div>
          </div>
        );
      };

      const Alert = ({ message, type = 'error' }) => {
        if (!message) return null;
        const colors = {
          error: 'border-red-500 bg-red-900 text-red-200',
          success: 'border-green-500 bg-green-900 text-green-200',
        };
        return (
          <div className={`p-4 border-l-4 ${colors[type]} rounded-lg my-4`} role="alert">
            <p className="font-bold">{type === 'error' ? 'Error' : 'Success'}</p>
            <p>{message}</p>
          </div>
        );
      };

      // --- Authentication Pages ---
      const AuthScreen = () => {
        const [isLogin, setIsLogin] = useState(true);
        const [email, setEmail] = useState('');
        const [password, setPassword] = useState('');
        const [error, setError] = useState('');

        const handleSubmit = async (e) => {
          e.preventDefault();
          setError('');
          try {
            if (isLogin) {
              await signInWithEmailAndPassword(auth, email, password);
            } else {
              await createUserWithEmailAndPassword(auth, email, password);
            }
          } catch (err) {
            setError(err.message);
          }
        };

        return (
          <div className="min-h-screen flex items-center justify-center bg-gray-900">
            <div className="max-w-md w-full bg-gray-800 shadow-xl rounded-xl p-8">
              <h2 className="text-3xl font-bold text-center text-green-400 mb-6">
                Grow Companion
              </h2>
              <form onSubmit={handleSubmit} className="space-y-6">
                <div>
                  <label htmlFor="email" className="block text-sm font-medium text-gray-300">
                    Email address
                  </label>
                  <input
                    id="email"
                    name="email"
                    type="email"
                    autoComplete="email"
                    required
                    value={email}
                    onChange={(e) => setEmail(e.target.value)}
                    className="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500"
                  />
                </div>
                <div>
                  <label htmlFor="password" className="block text-sm font-medium text-gray-300">
                    Password
                  </label>
                  <input
                    id="password"
                    name="password"
                    type="password"
                    autoComplete="current-password"
                    required
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                    className="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white shadow-sm placeholder-gray-400 focus:outline-none focus:ring-green-500 focus:border-green-500"
                  />
                </div>
                
                <Alert message={error} type="error" />

                <div>
                  <button
                    type="submit"
                    className="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"
                  >
                    {isLogin ? 'Sign In' : 'Sign Up'}
                  </button>
                </div>
              </form>
              <p className="mt-6 text-center text-sm text-gray-400">
                <button
                  onClick={() => setIsLogin(!isLogin)}
                  className="font-medium text-green-400 hover:text-green-300 focus:outline-none"
                >
                  {isLogin ? 'Need an account? Sign Up' : 'Have an account? Sign In'}
                </button>
              </p>
            </div>
          </div>
        );
      };

      // --- Budget Components ---
      const BudgetSummary = ({ totalBudget, totalSpent }) => {
        const budgetRemaining = totalBudget - totalSpent;
        return (
          <div className="bg-gray-800 rounded-xl shadow-lg p-6 mb-8">
            <div className="grid grid-cols-3 divide-x divide-gray-700 text-center">
              <div>
                <span className="text-sm font-medium text-gray-400">Total Budget</span>
                <p className="text-2xl font-bold text-green-400">{formatCurrency(totalBudget)}</p>
              </div>
              <div>
                <span className="text-sm font-medium text-gray-400">Total Spent</span>
                <p className="text-2xl font-bold text-red-400">{formatCurrency(totalSpent)}</p>
              </div>
              <div>
                <span className="text-sm font-medium text-gray-400">Remaining</span>
                <p className="text-2xl font-bold text-blue-400">{formatCurrency(budgetRemaining)}</p>
              </div>
            </div>
          </div>
        );
      };

      const BudgetItem = ({ item, phaseId, onToggle, onSave, onDelete }) => {
        const [isEditing, setIsEditing] = useState(false);
        const [editData, setEditData] = useState({ ...item });
        const [showStaticSuggestion, setShowStaticSuggestion] = useState(false);
        const [aiSuggestion, setAiSuggestion] = useState({ loading: false, text: null });

        const handleEditChange = (e) => {
          const { name, value, type } = e.target;
          setEditData(prev => ({
            ...prev,
            [name]: type === 'number' ? parseFloat(value) || 0 : value
          }));
        };

        const handleSave = () => {
          onSave(phaseId, editData);
          setIsEditing(false);
        };

        const handleGetAI = async () => {
          setAiSuggestion({ loading: true, text: null });
          const suggestionText = await getAISuggestion(item);
          setAiSuggestion({ loading: false, text: suggestionText });
        };

        if (isEditing) {
          return (
            <div className="py-4 border-b border-gray-700 bg-gray-700 p-4 rounded-lg">
              <input type="text" name="name" value={editData.name} onChange={handleEditChange} className="w-full bg-gray-600 rounded p-2 mb-2 text-white font-bold" />
              <input type="number" name="cost" value={editData.cost} onChange={handleEditChange} className="w-1/2 bg-gray-600 rounded p-2 mb-2 text-white" placeholder="Cost (R)" />
              <textarea name="reason" value={editData.reason} onChange={handleEditChange} className="w-full bg-gray-600 rounded p-2 mb-2 text-white text-sm" rows="2" placeholder="Reason/Notes" />
              <input type="text" name="link" value={editData.link} onChange={handleEditChange} className="w-full bg-gray-600 rounded p-2 mb-2 text-white text-sm" placeholder="Product Link" />
              <div className="flex gap-2">
                <button onClick={handleSave} className="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Save</button>
                <button onClick={() => setIsEditing(false)} className="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">Cancel</button>
              </div>
            </div>
          );
        }

        return (
          <div className="py-4 border-b border-gray-700 last:border-b-0">
            <div className="flex items-start">
              <input
                type="checkbox"
                id={item.id}
                checked={item.purchased}
                onChange={() => onToggle(phaseId, item.id)}
                className="h-6 w-6 bg-gray-700 border-gray-600 rounded text-green-500 focus:ring-green-600 mr-4 mt-1 flex-shrink-0"
              />
              <div className="flex-1" style={{ opacity: item.purchased ? 0.5 : 1 }}>
                <div className="flex justify-between items-center">
                  <label htmlFor={item.id} className={`font-bold text-lg ${item.purchased ? 'line-through' : ''} cursor-pointer`}>{item.name}</label>
                  <span className="text-lg font-semibold text-green-400 ml-4 flex-shrink-0">{formatCurrency(item.cost)}</span>
                </div>
                <p className={`text-sm text-gray-300 my-2 ${item.purchased ? 'line-through' : ''}`}>{item.reason}</p>
                {item.link && (
                  <a href={item.link} target="_blank" rel="noopener noreferrer" className={`text-sm text-blue-400 hover:underline truncate ${item.purchased ? 'pointer-events-none' : ''}`}>
                    View Product Link
                  </a>
                )}
              </div>
              <div className="flex flex-col ml-2 space-y-2 flex-shrink-0">
                <button onClick={() => setIsEditing(true)} title="Edit Item" className="p-2 bg-gray-700 hover:bg-gray-600 rounded-full text-blue-400"><IconPencil /></button>
                <button onClick={() => onDelete(phaseId, item.id)} title="Delete Item" className="p-2 bg-gray-700 hover:bg-gray-600 rounded-full text-red-400"><IconTrash /></button>
              </div>
            </div>
            <div className="mt-4 pl-10">
              <div className="flex gap-2 flex-wrap">
                {item.suggestions && (
                  <button
                    onClick={() => setShowStaticSuggestion(s => !s)}
                    className="text-xs bg-blue-800 hover:bg-blue-700 text-white py-1 px-3 rounded-full"
                  >
                    {showStaticSuggestion ? 'Hide' : 'View'} Alternatives
                  </button>
                )}
                <button
                  onClick={handleGetAI}
                  disabled={aiSuggestion.loading}
                  className="text-xs bg-purple-800 hover:bg-purple-700 text-white py-1 px-3 rounded-full disabled:opacity-50"
                >
                  {aiSuggestion.loading ? 'Thinking...' : 'Get AI Suggestion'}
                </button>
              </div>
              {showStaticSuggestion && item.suggestions && (
                <div className="mt-3 p-3 bg-gray-700 rounded-lg text-sm text-gray-200 whitespace-pre-wrap">
                  <h4 className="font-bold text-gray-100">Quick Alternatives:</h4>
                  {item.suggestions}
                </div>
              )}
              {aiSuggestion.loading && (
                <div className="mt-3 p-3 bg-gray-700 rounded-lg text-sm text-gray-200">
                  <p className="animate-pulse">Asking AI for up-to-date suggestions...</p>
                </div>
              )}
              {aiSuggestion.text && (
                <div className="mt-3 p-3 bg-gray-700 border-l-4 border-purple-500 rounded-lg text-sm text-gray-200 whitespace-pre-wrap">
                  <h4 className="font-bold text-purple-300">AI Suggestion:</h4>
                  {aiSuggestion.text}
                </div>
              )}
            </div>
          </div>
        );
      };

      const AddItemForm = ({ phaseId, onSave, onCancel }) => {
        const [newData, setNewData] = useState({ name: '', cost: 0, reason: '', link: '' });

        const handleChange = (e) => {
          const { name, value, type } = e.target;
          setNewData(prev => ({
            ...prev,
            [name]: type === 'number' ? parseFloat(value) || 0 : value
          }));
        };

        const handleSave = (e) => {
          e.preventDefault();
          if (!newData.name || newData.cost < 0) return;
          const newItem = {
            ...newData,
            id: `custom-${crypto.randomUUID()}`,
            purchased: false,
            suggestions: '',
          };
          onSave(phaseId, newItem);
          onCancel();
        };

        return (
          <form onSubmit={handleSave} className="py-4 mt-4 border-t border-gray-600 bg-gray-700 p-4 rounded-lg">
            <h3 className="text-lg font-semibold mb-2">Add New Item</h3>
            <input type="text" name="name" value={newData.name} onChange={handleChange} className="w-full bg-gray-600 rounded p-2 mb-2 text-white" placeholder="Item Name" required />
            <input type="number" name="cost" value={newData.cost} onChange={handleChange} className="w-1/2 bg-gray-600 rounded p-2 mb-2 text-white" placeholder="Cost (R)" />
            <textarea name="reason" value={newData.reason} onChange={handleChange} className="w-full bg-gray-600 rounded p-2 mb-2 text-white text-sm" rows="2" placeholder="Reason/Notes" />
            <input type="text" name="link" value={newData.link} onChange={handleChange} className="w-full bg-gray-600 rounded p-2 mb-2 text-white text-sm" placeholder="Product Link" />
            <div className="flex gap-2">
              <button type="submit" className="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Add Item</button>
              <button type="button" onClick={onCancel} className="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">Cancel</button>
            </div>
          </form>
        );
      };
      
      const PhaseAccordion = ({ phase, onToggleItem, onSaveItem, onDeleteItem, onAddItem }) => {
        const [isOpen, setIsOpen] = useState(phase.id === 'p1');
        const [showAddForm, setShowAddForm] = useState(false);

        const phaseTotal = phase.items.reduce((sum, item) => sum + item.cost, 0);
        const itemsPurchased = phase.items.filter(item => item.purchased).length;

        return (
          <div className="bg-gray-800 rounded-lg shadow-md mb-4 overflow-hidden">
            <button onClick={() => setIsOpen(!isOpen)} className="flex justify-between items-center w-full p-5 text-left">
              <div>
                <h2 className="text-xl font-semibold text-white">{phase.title}</h2>
                <p className="text-sm text-gray-400">{phase.timeline}</p>
                <p className="text-sm font-medium text-blue-300 mt-1">
                  {itemsPurchased} / {phase.items.length} items purchased ({formatCurrency(phaseTotal)})
                </p>
              </div>
              <IconChevron isOpen={isOpen} />
            </button>
            {isOpen && (
              <div className="px-5 pb-5 border-t border-gray-700">
                {phase.items.map(item => (
                  <BudgetItem
                    key={item.id}
                    item={item}
                    phaseId={phase.id}
                    onToggle={onToggleItem}
                    onSave={onSaveItem}
                    onDelete={onDeleteItem}
                  />
                ))}
                {!showAddForm ? (
                  <button
                    onClick={() => setShowAddForm(true)}
                    className="mt-4 text-green-400 hover:text-green-300 font-semibold flex items-center gap-1"
                  >
                    <IconAdd /> Add New Item
                  </button>
                ) : (
                  <AddItemForm
                    phaseId={phase.id}
                    onSave={onAddItem}
                    onCancel={() => setShowAddForm(false)}
                  />
                )}
              </div>
            )}
          </div>
        );
      };

      // --- Budget Page ---
      const BudgetPage = ({ project, projectRef }) => {
        const [phases, setPhases] = useState(project.budget.phases);

        const updateFirebase = async (newPhases) => {
          try {
            await updateDoc(projectRef, { "budget.phases": newPhases });
          } catch (error) {
            console.error("Error updating budget: ", error);
          }
        };

        const handleToggleItem = (phaseId, itemId) => {
          const newPhases = phases.map(p => {
            if (p.id === phaseId) {
              return { ...p, items: p.items.map(i => i.id === itemId ? { ...i, purchased: !i.purchased } : i) };
            }
            return p;
          });
          setPhases(newPhases);
          updateFirebase(newPhases);
        };

        const handleSaveItem = (phaseId, updatedItem) => {
          const newPhases = phases.map(p => {
            if (p.id === phaseId) {
              return { ...p, items: p.items.map(i => i.id === updatedItem.id ? updatedItem : i) };
            }
            return p;
          });
          setPhases(newPhases);
          updateFirebase(newPhases);
        };

        const handleDeleteItem = (phaseId, itemId) => {
          const newPhases = phases.map(p => {
            if (p.id === phaseId) {
              return { ...p, items: p.items.filter(i => i.id !== itemId) };
            }
            return p;
          });
          setPhases(newPhases);
          updateFirebase(newPhases);
        };

        const handleAddItem = (phaseId, newItem) => {
          const newPhases = phases.map(p => {
            if (p.id === phaseId) {
              return { ...p, items: [...p.items, newItem] };
            }
            return p;
          });
          setPhases(newPhases);
          updateFirebase(newPhases);
        };

        const [totalBudget, totalSpent] = useMemo(() => {
          let budget = 0;
          let spent = 0;
          for (const phase of phases) {
            for (const item of phase.items) {
              budget += item.cost;
              if (item.purchased) {
                spent += item.cost;
              }
            }
          }
          return [budget, spent];
        }, [phases]);

        return (
          <React.Fragment>
            <BudgetSummary totalBudget={totalBudget} totalSpent={totalSpent} />
            <div className="space-y-4">
              {phases.map(phase => (
                <PhaseAccordion
                  key={phase.id}
                  phase={phase}
                  onToggleItem={handleToggleItem}
                  onSaveItem={handleSaveItem}
                  onDeleteItem={handleDeleteItem}
                  onAddItem={handleAddItem}
                />
              ))}
            </div>
          </React.Fragment>
        );
      };

      // --- Plants Page ---
      const PlantsPage = ({ project, projectRef }) => {
        // *** FIX: Replaced all '??' with '||' for Babel compatibility ***
        const [plants, setPlants] = useState(project.plants || []);
        const [showAddForm, setShowAddForm] = useState(false);
        const [newPlantName, setNewPlantName] = useState('');
        const [newPlantStrain, setNewPlantStrain] = useState('');

        const updateFirebase = async (newPlants, newJournal) => {
          try {
            const updateData = { plants: newPlants };
            if (newJournal) {
              updateData.journal = newJournal;
            }
            await updateDoc(projectRef, updateData);
          } catch (error) {
            console.error("Error updating plants: ", error);
          }
        };
        
        const handleAddPlant = (e) => {
          e.preventDefault();
          if (!newPlantName.trim()) return;
          const newPlant = {
            id: `plant-${crypto.randomUUID()}`,
            name: newPlantName,
            strain: newPlantStrain,
            createdAt: new Date().toISOString(),
          };
          const newPlants = [...plants, newPlant];
          setPlants(newPlants);
          updateFirebase(newPlants);
          setNewPlantName('');
          setNewPlantStrain('');
          setShowAddForm(false);
        };

        const handleDeletePlant = (plantId) => {
          if (!window.confirm("Are you sure you want to delete this plant and all its journal entries?")) return;
          
          const newPlants = plants.filter(p => p.id !== plantId);
          setPlants(newPlants);

          // Also delete journal entries for this plant
          // *** FIX: Replaced all '??' with '||' for Babel compatibility ***
          const newJournal = { ...(project.journal || {}) };
          delete newJournal[plantId];
          
          updateFirebase(newPlants, newJournal);
        };

        return (
          <div className="bg-gray-800 rounded-lg shadow-md p-6">
            <h2 className="text-2xl font-semibold text-white mb-4">My Plants</h2>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              {plants.map(plant => (
                <div key={plant.id} className="bg-gray-700 rounded-lg p-4 flex justify-between items-center">
                  <div>
                    <p className="text-xl font-bold text-green-400">{plant.name}</p>
                    <p className="text-sm text-gray-300">{plant.strain || 'Unknown Strain'}</p>
                    <p className="text-xs text-gray-400">Planted: {formatDate(plant.createdAt)}</p>
                  </div>
                  <button onClick={() => handleDeletePlant(plant.id)} title="Delete Plant" className="p-2 bg-gray-600 hover:bg-gray-500 rounded-full text-red-400">
                    <IconTrash />
                  </button>
                </div>
              ))}
            </div>
            
            {!showAddForm ? (
              <button
                onClick={() => setShowAddForm(true)}
                className="mt-6 text-green-400 hover:text-green-300 font-semibold flex items-center gap-1"
              >
                <IconAdd /> Add New Plant
              </button>
            ) : (
              <form onSubmit={handleAddPlant} className="py-4 mt-6 border-t border-gray-600">
                <h3 className="text-lg font-semibold mb-2">Add New Plant</h3>
                <input
                  type="text"
                  value={newPlantName}
                  onChange={(e) => setNewPlantName(e.target.value)}
                  className="w-full bg-gray-600 rounded p-2 mb-2 text-white"
                  placeholder="Plant Name (e.g., 'Indoor 1')"
                  required
                />
                <input
                  type="text"
                  value={newPlantStrain}
                  onChange={(e) => setNewPlantStrain(e.target.value)}
                  className="w-full bg-gray-600 rounded p-2 mb-4 text-white"
                  placeholder="Strain (e.g., 'Cherry Pie')"
                />
                <div className="flex gap-2">
                  <button type="submit" className="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Add Plant</button>
                  <button type="button" onClick={() => setShowAddForm(false)} className="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">Cancel</button>
                </div>
              </form>
            )}
          </div>
        );
      };

      // --- Journal Page ---
      const JournalPage = ({ project, projectRef }) => {
        // *** FIX: Replaced all '??' with '||' for Babel compatibility ***
        const [plants, setPlants] = useState(project.plants || []);
        const [journal, setJournal] = useState(project.journal || {});
        const [selectedPlantId, setSelectedPlantId] = useState(null);
        const [newEntry, setNewEntry] = useState('');

        const selectedPlant = plants.find(p => p.id === selectedPlantId);
        const plantEntries = (selectedPlantId && journal[selectedPlantId]) ? journal[selectedPlantId] : [];

        const updateFirebase = async (newJournal) => {
          try {
            await updateDoc(projectRef, { journal: newJournal });
          } catch (error) {
            console.error("Error updating journal: ", error);
          }
        };

        const handleAddEntry = (e) => {
          e.preventDefault();
          if (!newEntry.trim() || !selectedPlantId) return;

          const entry = {
            id: `entry-${crypto.randomUUID()}`,
            date: new Date().toISOString(),
            text: newEntry,
          };
          
          const newPlantEntries = [...plantEntries, entry];
          const newJournal = {
            ...journal,
            [selectedPlantId]: newPlantEntries
          };

          setJournal(newJournal);
          updateFirebase(newJournal);
          setNewEntry('');
        };
        
        const handleDeleteEntry = (entryId) => {
          const newPlantEntries = plantEntries.filter(entry => entry.id !== entryId);
          const newJournal = {
            ...journal,
            [selectedPlantId]: newPlantEntries
          };
          setJournal(newJournal);
          updateFirebase(newJournal);
        };

        return (
          <div className="bg-gray-800 rounded-lg shadow-md p-6">
            <h2 className="text-2xl font-semibold text-white mb-4">Grow Journal</h2>
            <select
              value={selectedPlantId || ''}
              onChange={(e) => setSelectedPlantId(e.target.value)}
              className="w-full bg-gray-700 border border-gray-600 rounded p-2 mb-4 text-white"
            >
              <option value="" disabled>-- Select a plant --</option>
              {plants.map(plant => (
                <option key={plant.id} value={plant.id}>
                  {plant.name} ({plant.strain || '...'})
                </option>
              ))}
            </select>
            
            {!selectedPlant && (
              <p className="text-gray-400 text-center">Please select a plant to view its journal.</p>
            )}

            {selectedPlant && (
              <div>
                <form onSubmit={handleAddEntry} className="mb-4">
                  <textarea
                    value={newEntry}
                    onChange={(e) => setNewEntry(e.target.value)}
                    className="w-full bg-gray-600 rounded p-2 mb-2 text-white"
                    rows="3"
                    placeholder={`What's new with ${selectedPlant.name}? (e.g., 'Watered 1L, pH 6.5')`}
                    required
                  />
                  <button type="submit" className="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                    Add Journal Entry
                  </button>
                </form>

                <div className="space-y-4 max-h-96 overflow-y-auto">
                  {plantEntries.length === 0 && (
                    <p className="text-gray-400">No entries for this plant yet.</p>
                  )}
                  {plantEntries
                    .sort((a, b) => new Date(b.date) - new Date(a.date)) // Show newest first
                    .map(entry => (
                      <div key={entry.id} className="bg-gray-700 rounded-lg p-3">
                        <div className="flex justify-between items-center mb-1">
                          <p className="text-sm font-semibold text-green-400">{formatDate(entry.date)}</p>
                          <button onClick={() => handleDeleteEntry(entry.id)} className="text-red-500 hover:text-red-400">
                             <IconTrash />
                          </button>
                        </div>
                        <p className="text-gray-200 whitespace-pre-wrap">{entry.text}</p>
                      </div>
                    ))
                  }
                </div>
              </div>
            )}
          </div>
        );
      };

      // --- Project Detail Page ---
      const ProjectDetail = ({ project, onBack, onShare, onDelete, isOwner }) => {
        const [activeTab, setActiveTab] = useState('budget');
        const [projectData, setProjectData] = useState(project);
        
        // This is critical for real-time updates within the project
        useEffect(() => {
          const projectRef = getProjectRef(project.id);
          const unsub = onSnapshot(projectRef, (docSnap) => {
            if (docSnap.exists()) {
              setProjectData({ id: docSnap.id, ...docSnap.data() });
            } else {
              onBack(); // Project was deleted, go back
            }
          });
          return () => unsub();
        }, [project.id, onBack]);

        const projectRef = getProjectRef(project.id);
        
        const tabs = [
          { id: 'budget', name: 'Budget', icon: <IconBudget /> },
          { id: 'plants', name: 'My Plants', icon: <IconPlants /> },
          { id: 'journal', name: 'Journal', icon: <IconJournal /> },
        ];

        return (
          <div>
            <div className="flex justify-between items-center mb-6">
              <button onClick={onBack} className="flex items-center text-green-400 hover:text-green-300">
                <IconBack />
                <span className="ml-1">Back to Projects</span>
              </button>
              <h1 className="text-3xl font-bold text-white text-center">{projectData.name}</h1>
              <div>
                {isOwner && (
                  <button onClick={onShare} className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded-lg flex items-center gap-2 mr-2">
                    <IconShare /> Share
                  </button>
                )}
                {isOwner && (
                  <button onClick={onDelete} className="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-3 rounded-lg flex items-center gap-2">
                    <IconTrash />
                  </button>
                )}
              </div>
            </div>

            <div className="mb-6">
              <div className="flex space-x-1 rounded-lg bg-gray-800 p-1">
                {tabs.map(tab => (
                  <button
                    key={tab.id}
                    onClick={() => setActiveTab(tab.id)}
                    className={`flex-1 py-2 px-4 rounded-md text-sm font-medium flex items-center justify-center gap-2 transition
                      ${activeTab === tab.id
                        ? 'bg-green-600 text-white shadow'
                        : 'text-gray-300 hover:bg-gray-700 hover:text-white'
                      }`}
                  >
                    {tab.icon} {tab.name}
                  </button>
                ))}
              </div>
            </div>

            {/* Render active tab content */}
            {activeTab === 'budget' && <BudgetPage project={projectData} projectRef={projectRef} />}
            {activeTab === 'plants' && <PlantsPage project={projectData} projectRef={projectRef} />}
            {activeTab === 'journal' && <JournalPage project={projectData} projectRef={projectRef} />}
          </div>
        );
      };

      // --- Project Dashboard Page ---
      const ProjectDashboard = ({ user, onLogout }) => {
        const [projects, setProjects] = useState([]);
        const [loading, setLoading] = useState(true);
        const [showCreateModal, setShowCreateModal] = useState(false);
        const [showShareModal, setShowShareModal] = useState(false);
        const [selectedProject, setSelectedProject] = useState(null);
        const [newProjectName, setNewProjectName] = useState('');
        
        // Listen for all projects owned by or shared with the user
        useEffect(() => {
          setLoading(true);
          const q = query(collection(db, "projects"), where("members", "array-contains", user.uid));
          
          const unsub = onSnapshot(q, (querySnapshot) => {
            const userProjects = [];
            querySnapshot.forEach((doc) => {
              userProjects.push({ id: doc.id, ...doc.data() });
            });
            // *** FIX: Added check for createdAt.toDate ***
            setProjects(userProjects.sort((a,b) => ((b.createdAt && b.createdAt.toDate ? b.createdAt.toDate() : 0) - (a.createdAt && a.createdAt.toDate ? a.createdAt.toDate() : 0))));
            setLoading(false);
          }, (err) => {
            console.error("Error fetching projects: ", err);
            setLoading(false);
          });

          return () => unsub();
        }, [user.uid]);

        const handleCreateProject = async (e) => {
          e.preventDefault();
          if (!newProjectName.trim()) return;

          const newProjectData = {
            ...initialProject, // Use the default template
            name: newProjectName,
            ownerId: user.uid,
            members: [user.uid], // Owner is the first member
            createdAt: new Date()
          };
          
          try {
            await addDoc(collection(db, "projects"), newProjectData);
            setShowCreateModal(false);
            setNewProjectName('');
          } catch (err) {
            console.error("Error creating project: ", err);
          }
        };

        const handleDeleteProject = async (projectId) => {
          if (window.confirm("Are you sure you want to delete this project? This cannot be undone.")) {
            try {
              await deleteDoc(doc(db, "projects", projectId));
              setSelectedProject(null); // Go back to dashboard
            } catch (err) {
              console.error("Error deleting project: ", err);
            }
          }
        };

        const handleOpenShareModal = (project) => {
          setSelectedProject(project);
          setShowShareModal(true);
        };

        if (loading) {
          return <LoadingSpinner text="Loading Projects..." />;
        }
        
        if (selectedProject) {
          const isOwner = selectedProject.ownerId === user.uid;
          return (
            <ProjectDetail 
              project={selectedProject} 
              onBack={() => setSelectedProject(null)}
              onShare={() => handleOpenShareModal(selectedProject)}
              onDelete={() => handleDeleteProject(selectedProject.id)}
              isOwner={isOwner}
            />
          );
        }

        return (
          <div>
            <div className="flex justify-between items-center mb-6">
              <h1 className="text-3xl font-bold text-white">My Projects</h1>
              <button
                onClick={() => setShowCreateModal(true)}
                className="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2"
              >
                <IconAdd /> New Project
              </button>
            </div>
            
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
              {projects.map(project => (
                <div 
                  key={project.id} 
                  className="bg-gray-800 rounded-xl shadow-lg hover:shadow-2xl transition-shadow duration-300 flex flex-col justify-between cursor-pointer"
                  onClick={() => setSelectedProject(project)}
                >
                  <div className="p-6">
                    <h3 className="text-2xl font-bold text-green-400 mb-2">{project.name}</h3>
                    <p className="text-sm text-gray-400">
                      {project.ownerId === user.uid ? 'You are the owner' : `Shared with you`}
                    </p>
                  </div>
                  <div className="bg-gray-700 p-4 rounded-b-xl text-xs text-gray-300 flex justify-between">
                    {/* *** FIX: Replaced all '??' with '||' for Babel compatibility *** */}
                    <span>{(project.plants || []).length} Plants</span>
                    <span>{(project.budget && project.budget.phases ? project.budget.phases.reduce((acc, p) => acc + (p.items || []).length, 0) : 0)} Items</span>
                  </div>
                </div>
              ))}
            </div>
            
            {projects.length === 0 && (
              <div className="text-center text-gray-400 bg-gray-800 p-10 rounded-lg">
                <h3 className="text-xl font-semibold mb-2">No projects yet!</h3>
                <p>Click "New Project" to start planning your first grow.</p>
              </div>
            )}

            <Modal show={showCreateModal} onClose={() => setShowCreateModal(false)} title="Create New Project">
              <form onSubmit={handleCreateProject}>
                <label htmlFor="projectName" className="block text-sm font-medium text-gray-300">
                  Project Name
                </label>
                <input
                  id="projectName"
                  type="text"
                  value={newProjectName}
                  onChange={(e) => setNewProjectName(e.target.value)}
                  className="mt-1 block w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white shadow-sm"
                  placeholder="e.g., 'Winter Indoor Grow'"
                  required
                />
                <button
                  type="submit"
                  className="mt-6 w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700"
                >
                  Create Project
                </button>
              </form>
            </Modal>
            
            <ShareProjectModal 
              show={showShareModal}
              onClose={() => setShowShareModal(false)}
              project={selectedProject}
              user={user}
            />
          </div>
        );
      };

      // --- Friends Page ---
      const FriendsPage = ({ user }) => {
        const [friends, setFriends] = useState([]);
        const [requests, setRequests] = useState([]);
        const [loading, setLoading] = useState(true);
        const [friendEmail, setFriendEmail] = useState('');
        const [error, setError] = useState('');
        const [success, setSuccess] = useState('');

        // Fetch friends and requests
        useEffect(() => {
          const unsubFriends = onSnapshot(getFriendsCol(user.uid), (snapshot) => {
            const friendsList = [];
            snapshot.forEach(doc => friendsList.push(doc.data()));
            setFriends(friendsList);
          });
          
          const unsubRequests = onSnapshot(getFriendRequestsCol(user.uid), (snapshot) => {
            const requestsList = [];
            snapshot.forEach(doc => requestsList.push({ id: doc.id, ...doc.data() }));
            setRequests(requestsList);
            setLoading(false);
          });

          return () => {
            unsubFriends();
            unsubRequests();
          };
        }, [user.uid]);
        
        const handleSendRequest = async (e) => {
          e.preventDefault();
          setError('');
          setSuccess('');
          
          if (friendEmail === user.email) {
            setError("You can't add yourself as a friend.");
            return;
          }

          try {
            // Find user by email
            const q = query(getUsersCol(), where("email", "==", friendEmail));
            const querySnapshot = await getDocs(q);
            
            if (querySnapshot.empty) {
              setError("No user found with that email address.");
              return;
            }
            
            const targetUser = querySnapshot.docs[0].data();
            
            // Check if already friends
            const isAlreadyFriends = friends.some(f => f.uid === targetUser.uid);
            if (isAlreadyFriends) {
              setError("You are already friends with this user.");
              return;
            }
            
            // Send request (add to target's request list)
            const targetRequestsCol = getFriendRequestsCol(targetUser.uid);
            await addDoc(targetRequestsCol, {
              fromUid: user.uid,
              fromEmail: user.email,
              status: 'pending',
              createdAt: new Date(),
            });
            
            setSuccess(`Friend request sent to ${friendEmail}!`);
            setFriendEmail('');
            
          } catch (err) {
            console.error("Error sending friend request: ", err);
            setError("Failed to send friend request. " + (err.message || 'Unknown error.'));
          }
        };

        const handleRespondToRequest = async (request, action) => {
          try {
            const batch = writeBatch(db);
            
            // Delete the request
            const requestRef = doc(db, "users", user.uid, "friendRequests", request.id);
            batch.delete(requestRef);
            
            if (action === 'accept') {
              // Add to my friends list
              const myFriendRef = doc(db, "users", user.uid, "friends", request.fromUid);
              batch.set(myFriendRef, { uid: request.fromUid, email: request.fromEmail });
              
              // Add to their friends list
              const theirFriendRef = doc(db, "users", request.fromUid, "friends", user.uid);
              batch.set(theirFriendRef, { uid: user.uid, email: user.email });
            }
            
            await batch.commit();
            setSuccess(action === 'accept' ? 'Friend added!' : 'Request declined.');
            
          } catch (err) {
            console.error("Error responding to request: ", err);
            setError("Failed to respond to request. " + (err.message || 'Unknown error.'));
          }
        };

        const handleRemoveFriend = async (friendUid) => {
          if (window.confirm("Are you sure you want to remove this friend? This will un-share any projects you have shared with them.")) {
            try {
              const batch = writeBatch(db);
              
              // Remove from my friends list
              const myFriendRef = doc(db, "users", user.uid, "friends", friendUid);
              batch.delete(myFriendRef);
              
              // Remove me from their friends list
              const theirFriendRef = doc(db, "users", friendUid, "friends", user.uid);
              batch.delete(theirFriendRef);
              
              // TODO: Un-share projects (more complex)
              
              await batch.commit();
              setSuccess("Friend removed.");
              
            } catch (err) {
              console.error("Error removing friend: ", err);
              setError("Failed to remove friend. " + (err.message || 'Unknown error.'));
            }
          }
        };

        return (
          <div className="space-y-8">
            <div className="bg-gray-800 rounded-lg shadow-md p-6">
              <h2 className="text-2xl font-semibold text-white mb-4">Add a Friend</h2>
              <p className="text-sm text-gray-400 mb-4">You can share your projects with friends. Add a friend by entering their account email address.</p>
              <form onSubmit={handleSendRequest} className="flex gap-2">
                <input
                  type="email"
                  value={friendEmail}
                  onChange={(e) => setFriendEmail(e.target.value)}
                  className="flex-1 bg-gray-700 border border-gray-600 rounded p-2 text-white"
                  placeholder="Enter your friend's email"
                  required
                />
                <button
                  type="submit"
                  className="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2"
                >
                  <IconSend /> Send
                </button>
              </form>
              <Alert message={error} type="error" />
              <Alert message={success} type="success" />
            </div>

            <div className="bg-gray-800 rounded-lg shadow-md p-6">
              <h2 className="text-2xl font-semibold text-white mb-4">Pending Requests</h2>
              {loading && <p className="text-gray-400">Loading requests...</p>}
              {!loading && requests.length === 0 && <p className="text-gray-400">No new friend requests.</p>}
              <div className="space-y-2">
                {requests.map(req => (
                  <div key={req.id} className="bg-gray-700 p-3 rounded-lg flex justify-between items-center">
                    <span className="text-gray-200">{req.fromEmail}</span>
                    <div className="flex gap-2">
                      <button onClick={() => handleRespondToRequest(req, 'accept')} className="p-2 bg-green-600 hover:bg-green-700 rounded-full text-white"><IconAccept /></button>
                      <button onClick={() => handleRespondToRequest(req, 'decline')} className="p-2 bg-red-600 hover:bg-red-700 rounded-full text-white"><IconDecline /></button>
                    </div>
                  </div>
                ))}
              </div>
            </div>

            <div className="bg-gray-800 rounded-lg shadow-md p-6">
              <h2 className="text-2xl font-semibold text-white mb-4">My Friends</h2>
              {loading && <p className="text-gray-400">Loading friends...</p>}
              {!loading && friends.length === 0 && <p className="text-gray-400">You haven't added any friends yet.</p>}
              <div className="space-y-2">
                {friends.map(friend => (
                  <div key={friend.uid} className="bg-gray-700 p-3 rounded-lg flex justify-between items-center">
                    <span className="text-gray-200">{friend.email}</span>
                    <button onClick={() => handleRemoveFriend(friend.uid)} className="p-2 bg-gray-600 hover:bg-gray-500 rounded-full text-red-400">
                      <IconTrash />
                    </button>
                  </div>
                ))}
              </div>
            </div>
          </div>
        );
      };
      
      // --- Share Project Modal ---
      const ShareProjectModal = ({ show, onClose, project, user }) => {
        const [friends, setFriends] = useState([]);
        const [loading, setLoading] = useState(true);
        const [selectedFriendId, setSelectedFriendId] = useState('');
        const [error, setError] = useState('');
        const [success, setSuccess] = useState('');

        useEffect(() => {
          if (!show) return;
          setLoading(true);
          const unsub = onSnapshot(getFriendsCol(user.uid), (snapshot) => {
            const friendsList = [];
            snapshot.forEach(doc => friendsList.push(doc.data()));
            setFriends(friendsList);
            setLoading(false);
          });
          return () => unsub();
        }, [user.uid, show]);

        const handleShare = async (e) => {
          e.preventDefault();
          setError('');
          setSuccess('');
          if (!selectedFriendId) {
            setError("Please select a friend from the list.");
            return;
          }
          if (project.members.includes(selectedFriendId)) {
            setError("This project is already shared with that user.");
            return;
          }

          try {
            const projectRef = getProjectRef(project.id);
            await updateDoc(projectRef, {
              members: arrayUnion(selectedFriendId)
            });
            setSuccess("Project shared successfully!");
            setSelectedFriendId('');
          } catch (err) {
            console.error("Error sharing project: ", err);
            setError("Failed to share project. " + (err.message || 'Unknown error.'));
          }
        };
        
        const handleRemoveMember = async (memberId) => {
          if (memberId === project.ownerId) {
             setError("You cannot remove the project owner.");
             return;
          }
          try {
            const projectRef = getProjectRef(project.id);
            await updateDoc(projectRef, {
              members: arrayRemove(memberId)
            });
            setSuccess("User removed from project.");
          } catch (err) {
            console.error("Error removing member: ", err);
            setError("Failed to remove user. " + (err.message || 'Unknown error.'));
          }
        };

        // *** FIX: Replaced all '??' with '||' for Babel compatibility ***
        const projectMembers = project ? (project.members || []) : [];

        return (
          <Modal show={show} onClose={onClose} title="Share Project">
            <h3 className="text-lg font-semibold text-white mb-2">Share with a Friend</h3>
            <form onSubmit={handleShare} className="flex gap-2">
              <select
                value={selectedFriendId}
                onChange={(e) => setSelectedFriendId(e.target.value)}
                className="flex-1 bg-gray-700 border border-gray-600 rounded p-2 text-white"
                required
              >
                <option value="" disabled>Select a friend...</option>
                {loading && <option disabled>Loading friends...</option>}
                {!loading && friends.map(friend => (
                  <option key={friend.uid} value={friend.uid}>
                    {friend.email}
                  </option>
                ))}
              </select>
              <button
                type="submit"
                className="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg"
              >
                Share
              </button>
            </form>
            <Alert message={error} type="error" />
            <Alert message={success} type="success" />

            <h3 className="text-lg font-semibold text-white mt-6 mb-2">Project Members</h3>
            <div className="space-y-2">
              {projectMembers.map(memberId => (
                <div key={memberId} className="bg-gray-700 p-3 rounded-lg flex justify-between items-center">
                  <span className="text-gray-200">
                    {/* *** FIX: Replaced '?' with '||' for Babel compatibility *** */}
                    {memberId === user.uid ? (user.email + " (You)") : ((friends.find(f => f.uid === memberId) || {}).email || 'Unknown User')}
                  </span>
                  {memberId === (project && project.ownerId) && (
                    <span className="text-xs font-medium text-green-400 bg-green-900 px-2 py-0.5 rounded-full">Owner</span>
                  )}
                  {memberId !== (project && project.ownerId) && user.uid === (project && project.ownerId) && (
                     <button onClick={() => handleRemoveMember(memberId)} className="p-1 bg-gray-600 hover:bg-gray-500 rounded-full text-red-400">
                       <IconTrash />
                     </button>
                  )}
                </div>
              ))}
            </div>
          </Modal>
        );
      };

      // --- Main App Controller ---
      const AppController = () => {
        const { user, loading } = useAuth();
        const [activeTab, setActiveTab] = useState('projects');

        if (loading) {
          return <LoadingSpinner text="Authenticating..." />;
        }
        if (!user) {
          return <AuthScreen />;
        }
        
        const tabs = [
          { id: 'projects', name: 'My Projects', icon: <IconProject /> },
          { id: 'friends', name: 'Friends', icon: <IconFriends /> },
        ];

        return (
          <div className="min-h-screen bg-gray-900 text-white p-4 md:p-8 font-sans">
            <div className="max-w-6xl mx-auto">
              <header className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <div className="flex items-center gap-2">
                   <h1 className="text-2xl font-bold text-green-400">Grow Companion</h1>
                   <span className="text-xs font-medium text-gray-400 bg-gray-700 px-2 py-0.5 rounded-full">v5.1</span>
                </div>
                
                <nav className="flex-1 flex justify-center">
                   <div className="flex space-x-1 rounded-lg bg-gray-800 p-1">
                    {tabs.map(tab => (
                      <button
                        key={tab.id}
                        onClick={() => setActiveTab(tab.id)}
                        className={`flex-1 py-2 px-4 rounded-md text-sm font-medium flex items-center justify-center gap-2 transition
                          ${activeTab === tab.id
                            ? 'bg-green-600 text-white shadow'
                            : 'text-gray-300 hover:bg-gray-700 hover:text-white'
                          }`}
                      >
                        {tab.icon} {tab.name}
                      </button>
                    ))}
                  </div>
                </nav>
                
                <div className="flex items-center gap-4">
                  <div className="text-right">
                    <p className="text-sm text-gray-300">{user.email}</p>
                    <p className="text-xs text-gray-400 cursor-pointer" onClick={() => {
                      try {
                        navigator.clipboard.writeText(user.uid);
                        alert('User ID copied to clipboard!');
                      } catch(e) {
                        console.error('Failed to copy user ID: ', e);
                        alert('Failed to copy. Your User ID is: ' + user.uid);
                      }
                    }}>
                      Copy User ID
                    </p>
                  </div>
                  <button
                    onClick={() => signOut(auth)}
                    title="Sign Out"
                    className="bg-gray-700 hover:bg-red-700 hover:text-white text-red-400 font-bold p-3 rounded-full flex items-center"
                  >
                    <IconLogout />
                  </button>
                </div>
              </header>

              <main>
                {activeTab === 'projects' && <ProjectDashboard user={user} onLogout={() => signOut(auth)} />}
                {activeTab === 'friends' && <FriendsPage user={user} />}
              </main>
            </div>
          </div>
        );
      };

      // --- App Entry Point ---
      const App = () => (
        <AuthProvider>
          <AppController />
        </AuthProvider>
      );

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
